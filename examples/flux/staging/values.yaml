apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mcp-stack
spec:
  values:
    global:
      namespace: mcp-secrets
      domain: example.com
      environment: staging
      
      image:
        registry: registry.example.com
        pullPolicy: Always
      
      versioning:
        strategy: tag
      
      infisical:
        hostAPI: https://infisical.example.com
        projectSlug: my-project
        authCredentials:
          namespace: mcp-secrets
          name: infisical-credentials
      
      ingress:
        enabled: true
        className: nginx-staging
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-staging
        tls:
          enabled: true
      
      storage:
        className: standard
      
      autoscaling:
        enabled: false
      
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
    
    mcp:
      # MongoDB for staging
      mongo:
        enabled: true
        
        image:
          repository: mongo
          tag: "7.0"
        
        port: 27017
        replicas: 1
        
        autoscaling:
          enabled: false
        
        probes:
          liveness:
            enabled: true
            tcpSocket:
              port: 27017
            initialDelaySeconds: 60
            periodSeconds: 10
          
          readiness:
            enabled: true
            tcpSocket:
              port: 27017
            initialDelaySeconds: 10
            periodSeconds: 5
          
          startup:
            enabled: true
            tcpSocket:
              port: 27017
            failureThreshold: 30
        
        secret:
          create: true
          store:
            environmentSlug: staging
            secretsPath: /mongo-staging
          externalSecret:
            targetSecretName: mongo-secret-staging
        
        env:
          envFrom:
            - secretRef:
                name: mongo-secret-staging
        
        command: ["mongod"]
        args:
          - "--dbpath"
          - "/data/db"
          - "--bind_ip_all"
        
        persistence:
          enabled: true
          size: 5Gi
          storageClassName: standard
          mountPath: /data/db
        
        service:
          type: ClusterIP
          port: 27017
        
        ingress:
          enabled: false
        
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      
      # API Service for staging
      api-service:
        enabled: true
        
        image:
          repository: myapp/api
          tag: develop  # Auto-deploy from develop branch
        
        port: 8080
        replicas: 1
        
        autoscaling:
          enabled: false
        
        probes:
          liveness:
            enabled: true
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          
          readiness:
            enabled: true
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          
          startup:
            enabled: true
            httpGet:
              path: /startup
              port: 8080
            failureThreshold: 60
        
        secret:
          create: true
          store:
            environmentSlug: staging
            secretsPath: /api-staging
          externalSecret:
            targetSecretName: api-secret-staging
        
        env:
          envFrom:
            - secretRef:
                name: api-secret-staging
          env:
            - name: NODE_ENV
              value: "staging"
            - name: LOG_LEVEL
              value: "debug"
            - name: PORT
              value: "8080"
        
        persistence:
          enabled: false
        
        service:
          type: ClusterIP
          port: 80
          targetPort: 8080
        
        ingress:
          enabled: true
          annotations:
            nginx.ingress.kubernetes.io/rate-limit: "1000"
            nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
        
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
      
      # Redis for staging
      redis:
        enabled: true
        
        image:
          repository: redis
          tag: 7-alpine
        
        port: 6379
        replicas: 1
        
        autoscaling:
          enabled: false
        
        probes:
          liveness:
            enabled: true
            tcpSocket:
              port: 6379
            initialDelaySeconds: 30
            periodSeconds: 10
          
          readiness:
            enabled: true
            tcpSocket:
              port: 6379
            initialDelaySeconds: 5
            periodSeconds: 5
        
        secret:
          create: true
          store:
            environmentSlug: staging
            secretsPath: /redis-staging
          externalSecret:
            targetSecretName: redis-secret-staging
        
        env:
          envFrom:
            - secretRef:
                name: redis-secret-staging
        
        command: ["redis-server"]
        args:
          - "--appendonly"
          - "yes"
        
        persistence:
          enabled: true
          size: 2Gi
          storageClassName: standard
          mountPath: /data
        
        service:
          type: ClusterIP
          port: 6379
        
        ingress:
          enabled: false
        
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
